<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.8.0/styles/default.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.2/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.2/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.2/dist/index.js"></script><script>((r) => {
            setTimeout(r);
          })(() => {
  const { markmap, mm } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute("style", "position:absolute;bottom:20px;right:20px");
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"<pre><code class=\"language-markdown\"><span class=\"hljs-section\"># Declarative Infrastructure Automation Web App Project</span>\n\n<span class=\"hljs-section\">## Project Vision &amp; Initial DSL Proposal</span>\n<span class=\"hljs-bullet\">-</span> Initial User Need: Declarative application development (JS, Node, Python, Go, C background)\n<span class=\"hljs-bullet\">-</span> Proposed Path: Structured DSL design\n<span class=\"hljs-bullet\">  -</span> Define scope &amp; application domain\n<span class=\"hljs-bullet\">  -</span> Choose syntactic base: YAML, HCL, JSON, or embedded in existing languages (Python/JS)\n<span class=\"hljs-bullet\">  -</span> Define basic structure &amp; constructs (resources, desired state, variables, modularity, simple conditions)\n<span class=\"hljs-bullet\">-</span> Example: Simple Web App DSL (YAML)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`app`</span> (name, environment)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`servers`</span> (name, type, os, packages, services)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`databases`</span> (name, engine, version, users)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`api`</span> (endpoints, path, method, backend)\n<span class=\"hljs-bullet\">-</span> Comparison: Ansible vs Terraform vs Proposed DSL (Table)\n<span class=\"hljs-bullet\">-</span> Best Practices for DSL Syntax: Clear, readable, uniform naming, idempotence, simple expressions, modularity\n<span class=\"hljs-bullet\">-</span> Documentation Structure (Initial GitHub Wiki proposal)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/docs`</span> folder: <span class=\"hljs-code\">`Home.md`</span>, <span class=\"hljs-code\">`getting-started/`</span>, <span class=\"hljs-code\">`deep-dive/`</span>, <span class=\"hljs-code\">`how-to/`</span>, <span class=\"hljs-code\">`scripts/`</span>\n<span class=\"hljs-bullet\">  -</span> Markdown Best Practices: Clear formatting, internal links, folder organization, code examples\n\n<span class=\"hljs-section\">## Refined Project Scope: Hybrid &amp; Pragmatic Approach</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Decision:**</span> Focus on Web App (frontend/backend) for Infrastructure Automation via Workflow &amp; Pipeline using YAML\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> Leverage existing tools (Ansible, Django/React) without reinvention\n<span class=\"hljs-bullet\">-</span> Proposed Workflow DSL (YAML)\n<span class=\"hljs-bullet\">  -</span> Defines sequential/parallel workflows\n<span class=\"hljs-bullet\">  -</span> Invokes Ansible tasks for provisioning/config\n<span class=\"hljs-bullet\">  -</span> Calls Django API for app logic\n<span class=\"hljs-bullet\">  -</span> Triggers frontend operations\n<span class=\"hljs-bullet\">  -</span> Manages conditions and shared variables\n<span class=\"hljs-bullet\">-</span> Simplified Workflow Example (YAML)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`workflow`</span> (name, vars)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`steps`</span> (name, type: <span class=\"hljs-code\">`ansible`</span>, <span class=\"hljs-code\">`http_request`</span>, <span class=\"hljs-code\">`shell`</span>)\n<span class=\"hljs-bullet\">-</span> Integration Strategy:\n<span class=\"hljs-bullet\">  -</span> Ansible: Provisioning, config, deploy backend\n<span class=\"hljs-bullet\">  -</span> Django: REST API for app logic (DB migrations, users)\n<span class=\"hljs-bullet\">  -</span> React: Frontend for UI updates, notifications\n<span class=\"hljs-bullet\">-</span> Possible Architecture: Workflow Engine &lt;=&gt; Ansible Runner &lt;=&gt; Django API / Frontend React\n<span class=\"hljs-bullet\">-</span> Tech Choices for Workflow Engine: Apache Airflow (complex), Python/JS parser/executor, n8n, Prefect\n<span class=\"hljs-bullet\">-</span> Best Practices for DSL Workflow: Flat step list, shared vars (Ansible-style <span class=\"hljs-code\">`{{ var }}`</span>), simple error handling (<span class=\"hljs-code\">`continue_on_error`</span>), conditional steps (<span class=\"hljs-code\">`when`</span>), extensible modules.\n<span class=\"hljs-bullet\">-</span> Documentation Wiki Structure (Updated)\n\n<span class=\"hljs-section\">## DSL Revolution &amp; Optimization</span>\n<span class=\"hljs-bullet\">-</span> Identified Key Problems in Basic Model: Flat YAML for modularity, global variables, error handling, events, state, task extensibility.\n<span class=\"hljs-bullet\">-</span> Revolutionary Design Guidelines:\n<span class=\"hljs-bullet\">  -</span> Nested &amp; hierarchical structure\n<span class=\"hljs-bullet\">  -</span> Variable scoping (step, module, global)\n<span class=\"hljs-bullet\">  -</span> Conditional flows (<span class=\"hljs-code\">`if`</span>, <span class=\"hljs-code\">`switch`</span>)\n<span class=\"hljs-bullet\">  -</span> Events &amp; hooks (<span class=\"hljs-code\">`onSuccess`</span>, <span class=\"hljs-code\">`onError`</span>)\n<span class=\"hljs-bullet\">  -</span> Runtime state (checkpoint, rollback)\n<span class=\"hljs-bullet\">  -</span> Modular tasks with plugin system\n<span class=\"hljs-bullet\">  -</span> Output accessible for dynamic decisions\n<span class=\"hljs-bullet\">  -</span> Declarative parallelism\n<span class=\"hljs-bullet\">-</span> Optimized YAML Syntax Example (with comments)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`workflow`</span> (name, vars)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`stages`</span> (name, vars, tasks)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`tasks`</span> (id, type, playbook/method/command, extra<span class=\"hljs-emphasis\">_vars, output, retries, retry_</span>delay, onError, onSuccess, when)\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`events`</span> (name, actions: <span class=\"hljs-code\">`log`</span>)\n<span class=\"hljs-bullet\">-</span> Explanation of Innovations: Stages, scoped variables, task IDs/outputs, events/hooks, advanced error handling, declared parallelism, simple branching.\n<span class=\"hljs-bullet\">-</span> Workflow Engine Implementation: YAML parsing, internal object model, event bus, extensible task executor, internal scheduler, centralized logging.\n<span class=\"hljs-bullet\">-</span> Improved Documentation Wiki Structure (Comprehensive breakdown of DSL features)\n\n<span class=\"hljs-section\">## Technology Stack Decisions &amp; Refinement</span>\n<span class=\"hljs-bullet\">-</span> Discussion: Django + React as primary choices? Conceptual weaknesses?\n<span class=\"hljs-bullet\">  -</span> Django + React Pros: Mature, DRF, robust DB/auth, rich UI.\n<span class=\"hljs-bullet\">  -</span> Limits &amp; Alternatives (Table): Monolithic Django, JS state complexity, realtime scaling, external orchestrators.\n<span class=\"hljs-bullet\">  -</span> Cleaner Approaches: Microservices, Event-driven architecture, dedicated workflow engines (Temporal, Airflow), Serverless.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Decision:**</span> Adopt a Modern/Lean Stack\n<span class=\"hljs-bullet\">  -</span> Backend: <span class=\"hljs-strong\">**FastAPI + Celery**</span> (Async native, lightweight, task queue)\n<span class=\"hljs-bullet\">  -</span> Frontend: <span class=\"hljs-strong\">**Svelte**</span> (Zero-runtime, simple, reactive)\n<span class=\"hljs-bullet\">  -</span> Workflow Orchestration (Optional): <span class=\"hljs-strong\">**Temporal**</span> (stateful workflows, Python SDK) or <span class=\"hljs-strong\">**Apache Airflow**</span> (DAGs, broader ecosystem)\n<span class=\"hljs-bullet\">  -</span> Extension: <span class=\"hljs-strong\">**Pulumi + Go**</span> (programmable IaC), <span class=\"hljs-strong\">**OpenTofu**</span> (declarative infra provisioning)\n<span class=\"hljs-bullet\">  -</span> Integration: <span class=\"hljs-strong\">**GitHub Actions**</span> (CI/CD, GitOps)\n<span class=\"hljs-bullet\">-</span> Clarification: Ansible remains the <span class=\"hljs-strong\">**core automation engine**</span>.\n<span class=\"hljs-bullet\">-</span> Final Recommended Stack:\n<span class=\"hljs-bullet\">  -</span> Core: Ansible\n<span class=\"hljs-bullet\">  -</span> Backend: FastAPI + Celery\n<span class=\"hljs-bullet\">  -</span> Frontend: Svelte\n<span class=\"hljs-bullet\">  -</span> Optional Orchestration: Temporal/Airflow\n<span class=\"hljs-bullet\">  -</span> Optional IaC: Pulumi/Go, OpenTofu\n<span class=\"hljs-bullet\">  -</span> Optional CI/CD: GitHub Actions\n\n<span class=\"hljs-section\">## Implementation: Backend FastAPI + Celery (Initial PoC)</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> Expose API to run Ansible playbooks asynchronously, retrieve status.\n<span class=\"hljs-bullet\">-</span> Prerequisites: Python, Redis, Ansible, virtualenv.\n<span class=\"hljs-bullet\">-</span> Installation: <span class=\"hljs-code\">`pip install fastapi uvicorn celery redis ansible-runner`</span>\n<span class=\"hljs-bullet\">-</span> Project Structure: <span class=\"hljs-code\">`ansible_backend/`</span>, <span class=\"hljs-code\">`app.py`</span>, <span class=\"hljs-code\">`tasks.py`</span>, <span class=\"hljs-code\">`celery_worker.py`</span>, <span class=\"hljs-code\">`playbooks/`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`tasks.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`run_playbook(playbook_path, inventory_path)`</span>: Celery task, uses <span class=\"hljs-code\">`ansible_runner.run`</span>, captures output.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`FastAPI()`</span> app.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/run-playbook/`</span> (POST): Accepts <span class=\"hljs-code\">`playbook_name`</span>, calls <span class=\"hljs-code\">`run_playbook.delay`</span>, returns <span class=\"hljs-code\">`task_id`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/task-status/{task_id}`</span> (GET): Returns state and result using <span class=\"hljs-code\">`celery.result.AsyncResult`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`celery_worker.py`</span>: Basic Celery worker startup script.\n<span class=\"hljs-bullet\">-</span> Example: <span class=\"hljs-code\">`playbooks/site.yml`</span>, <span class=\"hljs-code\">`playbooks/inventory.ini`</span>.\n<span class=\"hljs-bullet\">-</span> Execution: Start Redis, Celery worker (<span class=\"hljs-code\">`celery -A tasks worker`</span>), FastAPI (<span class=\"hljs-code\">`uvicorn app:app`</span>).\n<span class=\"hljs-bullet\">-</span> Testing: <span class=\"hljs-code\">`curl -X POST /run-playbook/`</span>, then <span class=\"hljs-code\">`GET /task-status/{task_id}`</span>.\n\n<span class=\"hljs-section\">## Implementation: Frontend Svelte (Initial PoC)</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> Basic UI to trigger playbook and display status.\n<span class=\"hljs-bullet\">-</span> Setup: <span class=\"hljs-code\">`npm create vite@latest ansible-frontend -- --template svelte`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`App.svelte`</span>:\n<span class=\"hljs-bullet\">  -</span> Input for <span class=\"hljs-code\">`playbookName`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`Run Playbook`</span> button.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`taskStatus`</span> display.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`runPlaybook()`</span>: Fetches <span class=\"hljs-code\">`/run-playbook/`</span>, gets <span class=\"hljs-code\">`task_id`</span>, starts polling <span class=\"hljs-code\">`/task-status/{task_id}`</span>.\n<span class=\"hljs-bullet\">-</span> Execution: <span class=\"hljs-code\">`npm run dev`</span>.\n<span class=\"hljs-bullet\">-</span> Testing: Interact with UI.\n<span class=\"hljs-bullet\">-</span> Immediate Extension Ideas: List available playbooks, WebSocket for logs, authentication, richer UI.\n\n<span class=\"hljs-section\">## Integration &amp; Vision Alignment</span>\n<span class=\"hljs-bullet\">-</span> How it becomes a Full Web App:\n<span class=\"hljs-bullet\">  -</span> Backend (FastAPI + Celery) interprets/executes YAML playbooks via Ansible, orchestrates workflows.\n<span class=\"hljs-bullet\">  -</span> Frontend (Svelte) provides interactive UI for managing workflows, real-time feedback, configuration.\n<span class=\"hljs-bullet\">  -</span> Pipelines are composed of YAML playbooks with triggers, conditions, notifications.\n<span class=\"hljs-bullet\">  -</span> GitHub Actions integration ensures continuity with DevOps/GitOps.\n<span class=\"hljs-bullet\">-</span> Key Extensions Discussed: List available playbooks, detailed streaming logs (WebSocket), richer UI (host/params), GitHub auth &amp; notifications.\n\n<span class=\"hljs-section\">## Strategic &amp; Tooling Discussion (Self-Hosted Alternatives)</span>\n<span class=\"hljs-bullet\">-</span> Question: Is custom frontend reinventing the wheel (e.g., Semaphore)?\n<span class=\"hljs-bullet\">  -</span> Existing CI/CD Platforms: Semaphore, GitHub Actions, Jenkins are mature, feature-rich.\n<span class=\"hljs-bullet\">  -</span> Why Custom: Extreme customization, integration with existing stack, control/ownership, learning/prototyping.\n<span class=\"hljs-bullet\">  -</span> Disadvantages of Custom: Lack of ecosystem, development effort, robustness.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Decision:**</span> Use Git, but avoid vendor lock-in with GitHub.\n<span class=\"hljs-bullet\">  -</span> Git Hosting Alternatives: GitLab CE, Gitea, <span class=\"hljs-strong\">**Forgejo**</span> (recommended - lightweight, GitHub-like, community-driven), Bitbucket, SourceHut.\n<span class=\"hljs-bullet\">  -</span> CI/CD Alternatives: GitLab CI, Woodpecker CI, Drone CI, Jenkins, Buildkite, Tekton, Argo Workflows.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Recommendation:**</span> Forgejo + act-runner (GitHub Actions compatible CI/CD).\n<span class=\"hljs-bullet\">-</span> Proposed Flow: Git Hosting (Gitea/Forgejo) -&gt; Webhook to CI/CD (Woodpecker/Drone) -&gt; HTTP Call to FastAPI API (executes Ansible/OpenTofu) -&gt; Results to Frontend + Logs + Notifications.\n<span class=\"hljs-bullet\">-</span> Next Steps: Build Forgejo + act-runner stack, integrate backend, Git push pipelines, Codeberg Pages-style frontend, Docker Compose (Traefik variant).\n\n<span class=\"hljs-section\">## Full Project Generation Request</span>\n<span class=\"hljs-bullet\">-</span> User requests a complete, coesive, ready-for-GitHub project structure.\n<span class=\"hljs-bullet\">  -</span> Includes <span class=\"hljs-code\">`README.md`</span>, file structure, source code (commented), config files, examples, tests, <span class=\"hljs-code\">`.gitignore`</span>, <span class=\"hljs-code\">`LICENSE`</span>.\n\n<span class=\"hljs-section\">## Implementation: WebSocket for Realtime Logs</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> Stream playbook execution logs to frontend in real-time via WebSocket.\n<span class=\"hljs-bullet\">-</span> Strategy: Pub/Sub pattern with <span class=\"hljs-code\">`asyncio.Queue`</span> (for simplicity; Redis Pub/Sub for production).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/log_queue.py`</span>: <span class=\"hljs-code\">`log_queues = defaultdict(asyncio.Queue)`</span>, <span class=\"hljs-code\">`get_log_queue`</span>, <span class=\"hljs-code\">`remove_log_queue`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/tasks.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`run_playbook(task_id, playbook_path)`</span>: Uses <span class=\"hljs-code\">`subprocess.Popen`</span> to stream stdout/stderr.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`queue.put_nowait(line.strip())`</span> for each log line.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`queue.put_nowait(\"[end]\")`</span> on completion.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/websocket.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`APIRouter`</span> for <span class=\"hljs-code\">`/ws/logs/{task_id}`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`websocket_log_stream`</span>: <span class=\"hljs-code\">`await websocket.accept()`</span>, <span class=\"hljs-code\">`while True: message = await queue.get(); await websocket.send_text(message)`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/main.py`</span>:\n<span class=\"hljs-bullet\">  -</span> Imports <span class=\"hljs-code\">`websocket_router`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`app.include_router(websocket_router)`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/run/`</span> endpoint generates <span class=\"hljs-code\">`task_id`</span>, <span class=\"hljs-code\">`background_tasks.add_task(run_playbook.delay, task_id, ...)`</span>.\n<span class=\"hljs-bullet\">  -</span> CORS middleware enabled.\n<span class=\"hljs-bullet\">-</span> Frontend HTML Example: Basic JavaScript <span class=\"hljs-code\">`WebSocket`</span> client connects to <span class=\"hljs-code\">`/ws/logs/{task_id}`</span>, appends <span class=\"hljs-code\">`onmessage`</span> data to <span class=\"hljs-code\">`&lt;pre&gt;`</span>.\n\n<span class=\"hljs-section\">## Implementation: OpenTofu Integration</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> Execute OpenTofu projects (e.g., <span class=\"hljs-code\">`main.tf`</span>).\n<span class=\"hljs-bullet\">-</span> Directory: <span class=\"hljs-code\">`infrastructure/sample/`</span>.\n<span class=\"hljs-bullet\">-</span> Strategy: Similar to Ansible (task<span class=\"hljs-emphasis\">_id, log_</span>queue, existing WebSocket).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/tasks.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`run_tofu(task_id, project_path)`</span>: Celery task.\n<span class=\"hljs-bullet\">  -</span> Uses <span class=\"hljs-code\">`subprocess.Popen`</span> for <span class=\"hljs-code\">`tofu init`</span> and <span class=\"hljs-code\">`tofu apply -auto-approve`</span>.\n<span class=\"hljs-bullet\">  -</span> Streams logs via <span class=\"hljs-code\">`get_log_queue(task_id)`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/main.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/run/tofu/`</span> (POST) endpoint: Generates <span class=\"hljs-code\">`task_id`</span>, calls <span class=\"hljs-code\">`run_tofu.delay(task_id, project_path)`</span>.\n<span class=\"hljs-bullet\">-</span> Frontend HTML Example: Reuses the WebSocket log display, adds a \"Run OpenTofu\" button calling <span class=\"hljs-code\">`/run/tofu/`</span>.\n<span class=\"hljs-bullet\">-</span> Example <span class=\"hljs-code\">`infrastructure/sample/main.tf`</span> provided.\n\n<span class=\"hljs-section\">## Implementation: Svelte UI Refinement (Advanced)</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> Modern, interactive UI with tabs, YAML/TF editor, upload, variables, split view, recent tasks, dark mode, toast notifications.\n<span class=\"hljs-bullet\">-</span> Stack: SvelteKit, TailwindCSS, Monaco Editor, SweetAlert2, localStorage.\n<span class=\"hljs-bullet\">-</span> Frontend Structure: <span class=\"hljs-code\">`src/lib/components/`</span> for reusable elements.\n<span class=\"hljs-bullet\">-</span> Layout (<span class=\"hljs-code\">`+layout.svelte`</span>): Navbar, dark mode toggle, main content slot.\n<span class=\"hljs-bullet\">-</span> Tabbed Dashboard (<span class=\"hljs-code\">`+page.svelte`</span>): Buttons for <span class=\"hljs-code\">`Ansible`</span> and <span class=\"hljs-code\">`OpenTofu`</span> tabs, dynamically renders <span class=\"hljs-code\">`PlaybookRunner`</span> or <span class=\"hljs-code\">`TofuRunner`</span>.\n<span class=\"hljs-bullet\">-</span> Modular Components:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`Editor.svelte`</span>: Monaco Editor wrapper for code editing (<span class=\"hljs-code\">`content`</span>, <span class=\"hljs-code\">`language`</span>, <span class=\"hljs-code\">`onChange`</span>).\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`PlaybookRunner.svelte`</span>/<span class=\"hljs-code\">`TofuRunner.svelte`</span>: Buttons to run, display <span class=\"hljs-code\">`isRunning`</span> spinner, <span class=\"hljs-code\">`logs`</span> <span class=\"hljs-code\">`&lt;pre&gt;`</span> display, calls <span class=\"hljs-code\">`api.runPlaybook`</span>/<span class=\"hljs-code\">`api.runTofu`</span>, connects to WebSocket.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`SplitRunner.svelte`</span> (concept): Combines editor and log views.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`RecentTasks.svelte`</span>: Placeholder for listing tasks fetched from <span class=\"hljs-code\">`/api/tasks`</span>.\n<span class=\"hljs-bullet\">-</span> UI Features:\n<span class=\"hljs-bullet\">  -</span> File Upload: <span class=\"hljs-code\">`&lt;input type=\"file\"&gt;`</span> handled in runner components.\n<span class=\"hljs-bullet\">  -</span> Dynamic Variables: <span class=\"hljs-code\">`&lt;textarea&gt;`</span> for <span class=\"hljs-code\">`key: value`</span> pair input.\n<span class=\"hljs-bullet\">  -</span> Toast Notifications: <span class=\"hljs-code\">`npm i sweetalert2`</span>, <span class=\"hljs-code\">`utils/alerts.ts`</span> (<span class=\"hljs-code\">`toast()`</span>) for pop-up messages.\n<span class=\"hljs-bullet\">  -</span> Dark Mode: Tailwind <span class=\"hljs-code\">`darkMode: 'class'`</span>, <span class=\"hljs-code\">`localStorage`</span> for persistence (<span class=\"hljs-code\">`+layout.ts`</span>).\n<span class=\"hljs-bullet\">  -</span> Log History (<span class=\"hljs-code\">`routes/logs/+page.svelte`</span>): Placeholder for fetching completed tasks.\n\n<span class=\"hljs-section\">## Implementation: Authentication &amp; Task History (Backend)</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Goal:**</span> User authentication (GitHub/GitLab OAuth2), persistent task history in DB, API protection.\n<span class=\"hljs-bullet\">-</span> Database: PostgreSQL, managed with SQLAlchemy (async) and Alembic migrations.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`requirements.txt`</span>: Adds <span class=\"hljs-code\">`fastapi-users[sqlalchemy2,jwt,oauth]`</span>, <span class=\"hljs-code\">`passlib[bcrypt]`</span>, <span class=\"hljs-code\">`alembic`</span>, <span class=\"hljs-code\">`asyncpg`</span>, <span class=\"hljs-code\">`databases[asyncpg]`</span>, <span class=\"hljs-code\">`python-dotenv`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`.env.example`</span>: <span class=\"hljs-code\">`DATABASE_URL`</span>, <span class=\"hljs-code\">`SECRET_KEY`</span>, <span class=\"hljs-code\">`GITHUB_CLIENT_ID/SECRET`</span>, <span class=\"hljs-code\">`GITLAB_CLIENT_ID/SECRET`</span>, <span class=\"hljs-code\">`REDIS_URL`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/config.py`</span>: <span class=\"hljs-code\">`Settings`</span> class using <span class=\"hljs-code\">`pydantic.BaseSettings`</span> for env vars.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/db.py`</span>: <span class=\"hljs-code\">`Database`</span> instance, <span class=\"hljs-code\">`async_engine`</span>, <span class=\"hljs-code\">`async_session`</span> for SQLAlchemy.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/models.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`User(SQLAlchemyBaseUserTable, Base)`</span>: User model from <span class=\"hljs-code\">`fastapi-users`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`Task(Base)`</span>: <span class=\"hljs-code\">`id`</span>, <span class=\"hljs-code\">`type`</span>, <span class=\"hljs-code\">`status`</span>, <span class=\"hljs-code\">`created_at`</span>, <span class=\"hljs-code\">`updated_at`</span>, <span class=\"hljs-code\">`user_id`</span>, <span class=\"hljs-code\">`log`</span> (relationship to User).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/schemas.py`</span>: <span class=\"hljs-code\">`UserRead`</span>, <span class=\"hljs-code\">`UserCreate`</span>, <span class=\"hljs-code\">`TaskRead`</span> (Pydantic models).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/users.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`get_user_db()`</span>: <span class=\"hljs-code\">`SQLAlchemyUserDatabase`</span> adapter for <span class=\"hljs-code\">`fastapi-users`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`cookie_transport`</span>: <span class=\"hljs-code\">`CookieTransport`</span> for HTTP-only JWT cookies.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`get_jwt_strategy()`</span>: <span class=\"hljs-code\">`JWTStrategy`</span> with <span class=\"hljs-code\">`SECRET_KEY`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`auth_backend`</span>: <span class=\"hljs-code\">`AuthenticationBackend`</span> combining transport and strategy.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`fastapi_users`</span>: Main <span class=\"hljs-code\">`FastAPIUsers`</span> instance.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/auth.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`APIRouter`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`github_oauth_client`</span>: <span class=\"hljs-code\">`OAuth2AuthorizationCodeBearer`</span> for GitHub config (client ID/secret, URLs, scopes).\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/github/authorize`</span> endpoint.\n<span class=\"hljs-bullet\">  -</span> Includes <span class=\"hljs-code\">`fastapi_users.get_auth_router`</span>, <span class=\"hljs-code\">`get_register_router`</span>, <span class=\"hljs-code\">`get_users_router`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/tasks.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`APIRouter`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/`</span> (GET): <span class=\"hljs-code\">`list_tasks(session: AsyncSession)`</span> fetches <span class=\"hljs-code\">`Task`</span> records.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`/run/`</span> (POST), <span class=\"hljs-code\">`/run/tofu/`</span> (POST):\n<span class=\"hljs-bullet\">    -</span> Now requires <span class=\"hljs-code\">`user=Depends(current_active_user)`</span>.\n<span class=\"hljs-bullet\">    -</span> Creates <span class=\"hljs-code\">`TaskRecord`</span> in DB <span class=\"hljs-emphasis\">*before*</span> dispatching Celery task.\n<span class=\"hljs-bullet\">    -</span> Celery task updates DB <span class=\"hljs-code\">`status`</span> on start/success/failure.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/main.py`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`FastAPI`</span> app.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`origins`</span> for <span class=\"hljs-code\">`CORSMiddleware`</span> (includes frontend URL).\n<span class=\"hljs-bullet\">  -</span> Includes <span class=\"hljs-code\">`auth_router`</span>, <span class=\"hljs-code\">`tasks_router`</span>, <span class=\"hljs-code\">`fastapi_users`</span> routers.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`app.on_event(\"startup\")`</span>: Connects to DB, creates tables (if not existing).\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`app.on_event(\"shutdown\")`</span>: Disconnects from DB.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`app/celery_worker.py`</span>: <span class=\"hljs-code\">`celery_app`</span> definition.\n\n<span class=\"hljs-section\">## Implementation: Frontend with Auth &amp; Task History (Sketch)</span>\n<span class=\"hljs-bullet\">-</span> Dependencies: <span class=\"hljs-code\">`@auth/core`</span>, <span class=\"hljs-code\">`@auth/sveltekit`</span>, <span class=\"hljs-code\">`axios`</span>, <span class=\"hljs-code\">`svelte-toastify`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/lib/auth.ts`</span>: <span class=\"hljs-code\">`user`</span> writable store, <span class=\"hljs-code\">`fetchCurrentUser()`</span> (calls backend to get user session).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/lib/api.ts`</span>: <span class=\"hljs-code\">`axios`</span> instance with <span class=\"hljs-code\">`withCredentials: true`</span>, wrappers for auth (login, logout, <span class=\"hljs-code\">`getAuthUrl`</span>), user (<span class=\"hljs-code\">`getCurrentUser`</span>), tasks (<span class=\"hljs-code\">`listTasks`</span>), run (<span class=\"hljs-code\">`runPlaybook`</span>, <span class=\"hljs-code\">`runTofu`</span>).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/routes/login/+page.svelte`</span>: Login buttons for GitHub/GitLab, redirects to OAuth provider.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/routes/callback/+page.svelte`</span>: Handles OAuth redirect, <span class=\"hljs-code\">`fetchCurrentUser()`</span>, then navigates to <span class=\"hljs-code\">`/`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/routes/+layout.svelte`</span>: Uses <span class=\"hljs-code\">`$user`</span> store to show protected content (<span class=\"hljs-code\">`&lt;slot /&gt;`</span>) or login options (<span class=\"hljs-code\">`&lt;slot name=\"login\" /&gt;`</span>).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/lib/components/NavBar.svelte`</span>: Displays user email, logout button.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`src/routes/tasks/+page.svelte`</span>: Fetches and displays <span class=\"hljs-code\">`listTasks()`</span> for recent activity.\n\n<span class=\"hljs-section\">## Packaging: Docker Compose</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`docker-compose.yml`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`postgres`</span>: PostgreSQL DB.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`redis`</span>: Redis for Celery broker.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`backend`</span>: Builds from <span class=\"hljs-code\">`./backend`</span>, runs <span class=\"hljs-code\">`uvicorn`</span>, exposes <span class=\"hljs-code\">`8000`</span>, depends on <span class=\"hljs-code\">`postgres`</span>, <span class=\"hljs-code\">`redis`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`celery_worker`</span>: Builds from <span class=\"hljs-code\">`./backend`</span>, runs Celery worker, depends on <span class=\"hljs-code\">`backend`</span>, <span class=\"hljs-code\">`redis`</span>, <span class=\"hljs-code\">`postgres`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`frontend`</span>: Builds from <span class=\"hljs-code\">`./frontend`</span>, runs <span class=\"hljs-code\">`npm run dev`</span> (Vite), exposes <span class=\"hljs-code\">`5173`</span>.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`postgres_data`</span> volume.\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`infra_net`</span> network.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/Dockerfile`</span>, <span class=\"hljs-code\">`frontend/Dockerfile`</span>.\n\n<span class=\"hljs-section\">## Packaging: Traefik &amp; Kubernetes (Helm Chart)</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`docker-compose_traefik.yml`</span>:\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`traefik`</span>: Traefik <span class=\"hljs-code\">`v2.10`</span>, configures dashboard, Docker provider, Let's Encrypt resolver (<span class=\"hljs-code\">`your-email@example.com`</span>, <span class=\"hljs-code\">`traefik_letsencrypt`</span> volume).\n<span class=\"hljs-bullet\">  -</span> Backend and Frontend services include <span class=\"hljs-code\">`traefik.enable=true`</span> labels for automatic routing, <span class=\"hljs-code\">`Host()`</span> rules, <span class=\"hljs-code\">`entrypoints=websecure`</span>, <span class=\"hljs-code\">`tls.certresolver=letsencrypt`</span>.\n<span class=\"hljs-bullet\">-</span> Helm Chart (<span class=\"hljs-code\">`infra-automation-chart/`</span>):\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`Chart.yaml`</span>, <span class=\"hljs-code\">`values.yaml`</span> (configurable images, replica count, service ports, ingress hosts/TLS, DB credentials, environment variables).\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-code\">`templates/`</span>:\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-code\">`backend-deployment.yaml`</span>, <span class=\"hljs-code\">`backend-service.yaml`</span>.\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-code\">`celery-worker-deployment.yaml`</span>, <span class=\"hljs-code\">`celery-worker-service.yaml`</span>.\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-code\">`postgres-deployment.yaml`</span>, <span class=\"hljs-code\">`postgres-service.yaml`</span>.\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-code\">`redis-deployment.yaml`</span>, <span class=\"hljs-code\">`redis-service.yaml`</span>.\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-code\">`frontend-deployment.yaml`</span>, <span class=\"hljs-code\">`frontend-service.yaml`</span>.\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-code\">`ingress.yaml`</span>: Configures Kubernetes Ingress for frontend and backend hosts with TLS.\n<span class=\"hljs-bullet\">-</span> CI/CD Script (<span class=\"hljs-code\">`.github/workflows/deploy-k8s.yml`</span>):\n<span class=\"hljs-bullet\">  -</span> GitHub Actions workflow on <span class=\"hljs-code\">`push`</span> to <span class=\"hljs-code\">`main`</span>.\n<span class=\"hljs-bullet\">  -</span> Builds and pushes Docker images (backend, celery worker, frontend) to DockerHub (<span class=\"hljs-code\">`DOCKERHUB_USERNAME`</span>, <span class=\"hljs-code\">`DOCKERHUB_TOKEN`</span> secrets).\n<span class=\"hljs-bullet\">  -</span> Uses <span class=\"hljs-code\">`azure/setup-kubectl@v3`</span>.\n<span class=\"hljs-bullet\">  -</span> Deploys Helm Chart (<span class=\"hljs-code\">`helm upgrade --install`</span>) to Kubernetes namespace <span class=\"hljs-code\">`infra`</span> using <span class=\"hljs-code\">`KUBECONFIG`</span> secret.\n\n<span class=\"hljs-section\">## Final Repository Structure</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`infra-automation/`</span> root.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`README.md`</span> (comprehensive description, goals, tech, structure, install).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`LICENSE`</span> (MIT).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`.gitignore`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`docker-compose.yml`</span>, <span class=\"hljs-code\">`docker-compose-traefik.yml`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`.github/workflows/deploy-k8s.yml`</span>.\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`backend/`</span> (Dockerfile, requirements.txt, app/ with all Python modules).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`frontend/`</span> (Dockerfile, package.json, src/ with Svelte components/routes).\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`infra-automation-chart/`</span> (Chart.yaml, values.yaml, templates/).\n</code></pre>","children":[]},null)</script>
</body>
</html>
